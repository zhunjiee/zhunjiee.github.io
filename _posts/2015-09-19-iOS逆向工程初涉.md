---
layout: post
title: "iOS逆向工程初涉"
date: 2015-09-19
comments: false
categories: 知识囊
---

Android 的源码是开放的， 开发者很容易了解系统机制， 但是 iOS 的代码是封闭的， 单从文档上还是不足以深入的了解系统机制， 那么有没有方法能够对 iOS 进行逆向工程， 让开发者能够更深入了解系统？ 

首先，你必须要有很强的逆向sense，这个是逆向分析的基础，逆向的sense举个例子：如果你发现看到一个产品之后能够大致猜出它的架构，它的关键部分，核心算法以及可能存在的bug,甚至能够猜出影响性能的是哪部分，这个需要很长时间的逆向分析和工程开发的经验。BTW:语言什么的就不说了，ARM,X86指令,Objective-C,C,C++0x1.Tools: 你需要掌握以下工具:otool,lipo,ar,libtool,class-dump,mach-o-view(有空读一读它的代码，自己编译以下，加点功能什么的),hopper disassemble,ida pro,gdb,xcode开发要会的就不提了，还有一个很有用的codeunsign.

Frameworks: 调用私有API什么的是最简单的部分，最直接的路径是去private frameworks下面根据frameworks的名称猜测各个framework是干什么的，然后用class-dump dump出header，在项目里面引用就可以用了.如果观察力到位，发现某些官方app有某些功能能够猜测出背后可能有调用私有api，反汇编这个官方程序就能找到私有api的调用形式.

Kernel: ios 和macos都是bsd+mach-o的混合模型，网上有一个图很清楚，说明其架构的. mach-o 的格式学习的最佳途径就是看mach-oview这个开源项目的代码。

Defend technics used by Apple：用得最普遍得就是利用xpcservice将调用放在另外一个可执行程序中，然后函数调用通过进程间通信完成，核心得逻辑不会在这个xpc调用里面，该xpc远程程序会继续调用底层frameworks,最后你就很难找到最核心的逻辑和算法到底在哪里了；关键部分用c实现，然后隐藏data structure，只留出必要的指针，hidden pointer的技术，keychain的实现就是这样做的，要逆向出它keychain的数据库格式非常难，尝试过，失败了；另外一方面可能考虑到代码的可维护性，大部分苹果的代码都有很详细的log，可能有开关控制log的打开关闭，如果能把log开起来，一个程序，framework就很容易跟踪了(静态分析),打开这些log一般要直接修改二进制文件，或者修改特殊的plist文件.

static analysis:静态分析一般就是先定位最关键的地方，定位的方法很多，一般先开log，然后分析完log后通过关键字来找。定位成功后，没有什么底层技术时，你想要干的事情基本上就快完成了，逻辑就在你面前，汇编配合伪代码就很简单了(除了有FSM或者jmp table的情况,这种情况还是动态分析吧). 有些涉及到底层技术，有一种内核级别调用的陷入函数(涉及到mach-o内核机制)比较麻烦，这种情况也有一些办法，做起来怎么样都是限制大。

dynamic analysis:动态分析要配合静态来做，主要还是用xcode的调试器或者gdb，xcode的符号断点.f6-f7-f6慢慢调.

reimplement logics:功能重现，逆向里面经常要做的事情，一个加密算法，解密算法要重新实现一遍，让自己可以用。途径有两条：1.照着汇编写出汇编版，c版或者objective－c的实现；2.直接调用二进制中的函数. 途径1是考你功底的，功底深做起来就是个体力活而已。途径2有两条路，一是修改二进制文件，或者patch你要的逻辑到一个有架子了的二进制文件，二是计算函数地址动态加载。 重点讲一下途径2，静态修改很麻烦，直接暴露需要解决以下问题：mach-o文件中有两个section与export function有关，其中一个Symbol table和与之相关的String table较容易修改，另外一个是Dynamic loader info比较难修改，里面有的相对位置需要做uleb128转换，另外存储信息的格式是链表格式，解决这两个就可以了. 静态修改除了这些，mach-o前面与section对应的头信息也要修改，长度，位置偏移量.; 途径2的动态加载就不多说了，看我github的项目call_it_any_where 应该是目前为止最方便的方式。

jail-development:越狱开发其实门槛比app store还要低.这一块与逆向有关的主要是hook class之类的.

security issues: 建议手机别越狱，mac和ios下的maleware其实比windows下面还难发现.;keychain里面即使最严格的ACL策略也是能够绕过的;

讲一讲会逆向的好处：逆向是一门艺术也是一种研究方法，能够让你弄清楚程序运行的本来面目。看别人的实现也可以用来提升自己的架构能力。逆向能够找到一些诡异问题的root reason。最重要的是逆向能力强后，对程序，代码，算法，数据结构，计算机体系的认识会深刻很多。做项目也会从容很多，不太再会遇到什么bug搞不定。另外个人认为在漏洞挖掘上比起fuzzy逆向才是正途。